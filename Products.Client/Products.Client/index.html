<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title></title>
    <style>
        li{
            list-style-type: none;
            padding-bottom: 10px;
        }
        #products, #update{
            width: 500px;
            float: left
        }
    </style>
</head>
<body>
    <!--<a id="categories-link">Categories</a>
    <a id="products-link">Products</a>-->
    <div id="error-message"></div>
    <div id="content">
        <div id="products">
            <label for="search-name">Name</label>
            <input id="search-name" type="text" />
            <label for="search-categories">Category</label>
            <select id="search-categories">
                <option id=""></option>
            </select>
            <ul id="products-list"></ul>
            <input id="prev-page" type="button" value="Previous" disabled="disabled" />
            <input id="next-page" type="button" value="Next" />
        </div>        
        <div id="update">
            <form id="update-form" enctype="multipart/form-data">
                <input type="hidden" name="method" value="put" />
                <input type="hidden" name="id" id="product-id"/>
                <img width="200" height="100" />
                <br />
                <label for="name">Name </label>
                <input id="name" name="name" type="text" />
                <br />
                <label for="description">Description </label>
                <textarea id="description" name="description"></textarea>
                <br />
                <label for="category">Category</label>
                <select id="category" name="categoryid">
                    <option id="0"></option>
                </select>
                <br />
                <label for="image-file">Image </label>
                <input id="image-file" type="file" />
                <br />
                <input id="cancel-update" type="button" value="Cancel" />
                <input type="submit" value="Update" />
            </form>
        </div>
    </div>

    <script src="scripts/lib/jquery-1.11.2.min.js"></script>
    <script src="scripts/http-module.js"></script>
    <script>
        //TODO: organize code in separate files
        var baseUrl = 'http://localhost:53043/api/';
        var productsBaseUrl = baseUrl + 'products/';
        var categoriesBaseUrl = baseUrl + 'categories/';

        var currentPage = 0;
        var $searchProductName = $('#search-name');
        var $searchProductCategory = $('#search-categories');
        var $productsList = $('#products-list');
        var $updateDiv = $('#update');

        httpModule.get(categoriesBaseUrl, onLoadSearchCategories, onError);
        loadProducts();
        $updateDiv.hide();

        $searchProductName.keyup(function () {
            currentPage = 0;
            loadProducts();
        });
        $searchProductCategory.change(function () {
            currentPage = 0;
            loadProducts();
        });
        $('#prev-page').click(function () {
            currentPage -= 1;
            loadProducts();
        });
        $('#next-page').click(function () {
            currentPage += 1;
            $('#prev-page').removeAttr('disabled');
            loadProducts();
        });
        $("#update-form").submit(function () {
            //TODO: fix file is not sent
            var formData = new FormData($(this)[0]);

            $.ajax({
                url: productsBaseUrl,
                type: 'POST',
                data: formData,
                async: false,
                success: function (data) {
                    $updateDiv.hide();
                    alert('Product with id ' + data + 'was updated');
                },
                error: onError,
                cache: false,
                contentType: false,
                processData: false
            });

            return false;
        });
        $('#cancel-update').click(function () {
            $updateDiv.hide();
        });

        function loadProducts() {
            var name = $searchProductName.val();
            var categoryId = $searchProductCategory.find(':selected').attr('value');
            var searchUrl = productsBaseUrl + '?name=' + name + '&category=' + categoryId + '&page=' + currentPage;
            httpModule.get(searchUrl, renderProducts, onError);
            if (currentPage == 0) {
                $('#prev-page').attr('disabled', 'disabled');
            }
            //TODO: last page disable
        }

        function renderProducts(products) {            
            $productsList.children().remove();

            var $listItem = $('<li/>')
                .append($('<img width=50 height=25/>'))
                .append('<span href="#" class="name">')
                .append('<br>')
                .append('<a href="#" class="edit">Edit </a>')
                .append('<a href="#" class="delete">Delete </a>')
                .append('<br>');

            for (var i = 0; i < products.length; i++) {
                var product = products[i];
                var $currentListItem = $listItem.clone();
                $currentListItem.attr('id', product.ProductId);
                $currentListItem.find('img').attr('src', productsBaseUrl + 'img/' + product.ProductId);
                $currentListItem.find('.name').html(product.Name);
                $productsList.append($currentListItem);
            }

            $productsList.off().on("click", ".edit", onProductEdit);
            $productsList.on("click", ".delete", onProductDelete);
        }

        function onProductDelete() {
            var $listElement = $(this).parent();
            var result = confirm('Delete product ' + $listElement.find('.name').text());
            if (result == true) {
                var id = $listElement.attr('id');
                httpModule.del(productsBaseUrl + id,
                    {},
                    function(){
                        $productsList.find('#' + id).remove();
                    },
                    onError);
            }
        }

        function onProductEdit() {
            var id = $(this).parent().attr('id');
            var categoryForUpdatedProduct = $updateDiv.find('#category');
            httpModule.get(productsBaseUrl + 'byid/' + id, function (product) {
                httpModule.get(categoriesBaseUrl, onLoadUpdateCategories, onError);
                //TODO: call in call-back
                $updateDiv.show();
                $updateDiv.find('#product-id').val(id);
                $updateDiv.find('#name').val(product.Name);
                $updateDiv.find('#description').val(product.Description);
                categoryForUpdatedProduct.val(product.CategoryId);
                $updateDiv.find('img').attr('src', productsBaseUrl + 'img/' + id);
            }, onError);
        }

        function onLoadSearchCategories(categories) {
            renderCategories(categories, $searchProductCategory);
        }
        
        function onLoadUpdateCategories(categories) {
            renderCategories(categories, $updateDiv.find('#category'));
        }

        function renderCategories(categories, categoriesDomElement) {
            var $optionItem = $('<option/>');
            for (var i = 0; i < categories.length; i++) {
                var category = categories[i];
                var $currentOptionItem = $optionItem.clone();
                $currentOptionItem.attr('value', category.CategoryId);
                $currentOptionItem.html(category.Name);
                categoriesDomElement.append($currentOptionItem);
            }
        }

        function onError(err) {
            $('#error-message').text(err.message);
        }
    </script>
</body>

</html>
